#### 2. CPU 的结构

单片机内部
MCS51系列存储器容量是128B
MCS52系列存储器容量是256B
外扩,但是已经在内部了,使用的时候还是按外部使用
STC 系列2KB

--- 

P1口连接A/D转换(一般)
P3口连接中断,定时/计数器,串行口控制器

单片机的地址总线16根(P0低八位和P2高八位构成),数据总线8根

程序存储器 64KB:存储容量=$s^{16}=64KB$

单片机外部数据存储器的容量是64BK,程序存储器也是64KB,通过PESM判断
程序存储器中已经有一部分程序监视串口

CPU控制器:地址寄存器,指令译码寄存器,---


STC12C5A60S2

#### 3. 系统时钟(电路),复位电路及看门狗  
晶震:分两种,一种是晶体(无源晶震),另外一种是晶振或振荡器(有源晶震); 有源无源--》是否有时钟电路
时钟协调,右CPU控制器指挥和管理CPU的运算器和寄存器等部件进行工作和执行程序  
- 时钟周期(振荡周期): 定义为时钟脉冲的倒数, 如12M的晶振,时钟周期是1/12s, 是计算机中最基本的,最小的时间单位(单位 节拍 P)
- 状态周期:振荡脉冲经过二分频后定义为一个状态
- 机器周期:一条指令的执行要划分为几个阶段, 例如取指令, 存储器读,存储器写. 这每一项工作称为一个基本操作. 完成一个这样的基本操作需要1个机器周期
- 机器周期= 6状态周期= 12 个时钟周期

系统时钟通过晶震产生脉冲,计时  

##### 复位电路(自动复位,手动复位)  
**自动复位**:一上电自动复位,注意几个特点:复位上电的时间要保持在**20ms**以上  
**电容特性**:电压不能突变,隔直流  
典型C=10uF/16V,R=8.2KΩ  
**手动复位**: 按下开关短接电容,重新上电  

PC|存储器指针|0000H
-|-|-
SP|堆栈指针|07H,入栈是08H存起来
P0,P1,P2,P3|端口|0FFH
ACC|累加器|00H
PSW|程序状态字|00H

**看门狗**:当系统工作异常时自动产生一个复位信号,在硬件无故障时,使系统恢复正常工作  
**原理**:CPU隔一段时间就要访问一次看门狗,否则就认为时异常 看门狗地址:0xC1

**分频**:如12分频,就是12个脉冲输入,输出一个脉冲
#### 单片机的节电方式
1. 两种节点方式:空闲方式, 掉电方式
空闲方式下cpu进入休眠状态，由硬件或软件唤醒， 片内外部设备保持工作状态，RAM和特殊功能寄存器保持不变
掉电方式下所有设备停止工作，器件RAM和特殊sfr不变，但复位后sfr内容被初始化，RAM可能保持不变
CPU停止工作，中断、串口和计时器继续工作，堆栈指针、程序计数器、程序状态字、累加器、内部RAM和其他特殊功能寄存器内容不变
电源管理与波特率选择寄存器PCON:
地址|B7|B6||B5|B4|B3|B2|B1|B0|复位值
-|-|-|-|-|-|-|-|-|-|-|
87H|SMOD|SMODO|LVDF|POF<br>STC系列特有|GF1|GFO<br>这两位都是控制为|PD<br>掉电方式控制位|IDL<br>空闲方式控制位|OO11OOOO|

- IDL:空闲方式控制位,置1后使CPU进入空闲方式
- ALE,PSEM:保持高电平
- CPU进入空闲模式后退出的方法:
	- 一种被运行的中断源请求中断时;
	- 一种是硬件复位;
- 激活CPU时下一条语句不要设置

- PD:掉电方式控制位,置1后CPU进入掉电方式.内部部件会停止工作
- ALE,PSEM:保持为低电平
- 唯一方式是硬件复位:特殊功能寄存器初始化,RAM单元保持不变.
- 在掉电方式期间VCC电源降到2V,只有VCC恢复正常值才能退出掉电方式

#### 程序存储
- 讲:标准MCS51单片机, 内部只有低128B的RAM(数据存储器,随机存储器)和特殊功能寄存器
- 标准MCS52单片机,内部有低128B和高128B的RAM(数据存储器)间接寻址, 特殊功能寄存器(SFR,直接寻址). 比标准MCS51多一个定时器/计数器
- 在低128B的RAM中有32特殊寄存地址(有地址)(寄存器从R0到R7)
- 可以外扩16K 因为有16根地址总线$2^{16}=16K$
- PROM/Flash:程序存储器(即外扩内存,由于地址有冲突,所以用PSEM区分)

```
1. 64KB程序存储器空间:0~0xFFFF.
2. 低128B内部RAM空间0~0x7F
	- 高128内部RAM空间80~0xFF(间接寻址)
3. 128B内部特殊功能寄存器空间(SFR)80~0xFF.没全用,与高128B冲突(直接寻址)
4. 为寻址器0~0xFF
	- 字节单元地址(正常是这个),位单元地址(单片机特有)
	- 字节单元地址从20H~2FH和特殊功能寄存器的地址为8的倍的可以进行位寻址.
5. 64K外部数据存储器0-0xFFFF
```
#### 程序和数据存储在什么地方? 空间多大
> 存储数据空间: 存储器和寄存器  
> 51单片机以外的CPU寄存器是没有地址的  
> 51单片机以外的CPU寄存器在CPU内部  
> ROM (程序存储器)内部不够时会访问外部(地址重新开始)  
> 程序使用内部ROM(0000H-FFFFH)部分或者全部, ROM 内部不够时会访问外部(地址重新开始)  
> bit 只能定义位地址是00H到7FH(非特殊功能寄存器)这个空间的, 也就是字节位20H到2FH这个空间的; sbit 首先直接定义特殊功能寄存器区的SFR位地址变量, 也可以间接定义非特殊功能寄存器的位地址  
>A寄存器的写法有两种 A, ACC 这两种对于的汇编指令不同 如PUSH只能用ACC  
>程序存储器也可以存常量(不变)  
>P0 P2 用来描述地址端口  
1. RAM(数据存储器)空间划分:
	- 前32位是寄存器地址,前4组都是R0-R7, 通过PSW(程序状态寄存器) 判断是那组
	- 20H开始到2FH 可以进行位寻址(直接对某一位读写)- 位寻址: 直接对某一位读写
	- 2FH-7FH 开放区

2. 特殊功能寄存器:
	- 8的倍数可以位寻址

存储类型说明
存储类型|说明
-|-
code|程序存储器(64KB)</br> 用MOVC A 等形式访问
data|片内RAM的低128B(存放变量)+特殊功能寄存器</br> 用直接寻址方式访问</br>用MOV等形式方法
idata|片内RAM的全部256B(存放变量)</br>用间接寻址方式访问</br>用MOV A访问
bdata|片内RAM的位寻址空间(16KB, 0x20~0x2F)</br>SFR中的使用特殊名访问</br>CLR bit形式访问
xdata|片外RAM(64KB),用MOVX A形式访问
pdata|片外RAM的一页(256B)</br>用MOVX A形式访问

>keil中汇编指令对应的意义:0x008F<表示程序存储地址> D210<对应的机器码> SETB<操作码> FLAG1(0x22.0)<操作数, 0x22.0 0x22字节第0位>
>d:0 data, i:0 idata . 后面接10进制数表示开始 地址
> 后续学的嵌入式(ARM):存储模式有两种: 大端存储模式(单片机, PC机), 小端存储模式

### 外部存储器如何连接
P0, P1, P2, P3 口的区别
- P0: 普通输入输出,外部ROM地址总线低八位, 数据地址总线.(双向口, 输出锁存, 输入缓存, 输入前要设置1 , 输出要上拉电阻, 输入位高组态)
- P1: 输入要设置1, 无高组态, 只能输出或者输入
- P2: I/O与P1口一样, 当有片外存储器时作地址线使用, 寻址高八位片外数据存储器
- P3: I/O与P1口一样, 无论输入输出都要设置1, 有第二复用功能如下

引脚|P3端口第二功能定义
-|-
0|RXD
1|TXD
2|$\overline{INTO}$外部中断
3|$\overline{INT1}$
4|T0
5|T1
6|$\overline{WR}$外部存储器写有效
7|$\overline{RD}$----读有效
使用读-修改-回 都要使用锁存器

- 地址锁存器74LS373(因为P0 作为数据总线和低八位地址总线, 需要用地址锁存器保存第八位地址)高电平输入什么输出什么, 低电平输出上一个结果. 

外扩:
- 27256表示是EEPROM, 256 容量, 256Kbit=256KB
- 62256:62表示RAM, 256一样



